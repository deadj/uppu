{% include "DuplicateItems/header.phtml" %}
    <input type="hidden" id="fileId" value="{{ filesData.nameId }}">
    <div>
        <div class="fileBlock">
            {% if type == "video" %}
                <video src="{{ link }}" width="350" controls></video>
            {% elseif type == "audio" %}
                <audio src="{{ link }}" controls></audio>
            {% elseif type == "image" %}
                <img id="imgFile" src="{{ link }}" width="350">
            {% endif %}
            <ul class="fileInfo">
                <li>Название: {{ filesData.name }}</li>
                {% if size <= 1000 %}
                    <li>Размер: {{ filesData.size }} Кб.</li>
                {% else %}
                    <li>Размер: {{ filesData.size / 1000}} Мб.</li>
                {% endif %}
                <li>Дата загрузки: {{ filesData.date }}</li>
                <li>Комментарий: {{ filesData.comment }}</li>

                {% for data in filesData.metadata %}
                    <li>{{ data.dataName }}: {{ data.value }}</li>
                {% endfor %}
            </ul>
            <a class="uploadButton" href="{{ link }}" download="">Скачать</a>
        </div>
    </div>
    {% if comments|length > 0 %}
        <div class="commentsBlock" id="commentsBlock">
            {% for comment in comments %}
                <div class="comment">
                    <h5>{{ comment.date }}</h6>
                    <p>{{ comment.text }}</p>
                    <a href="">Ответить</a>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="commentsBlock" id="commentsBlock">
            <p>Ваш комментарий будет первым</p>
        </div>
    {% endif %}
    <form class="newCommentBlock" id="newCommentBlock">
        <textarea name="comment" id="newCommentsText" required></textarea>
        <button id="addCommentButton">Отправить</button>
    </form>
    <script>
        //проверять на пустой коммент
        newCommentBlock.onsubmit = async function(e){
            e.preventDefault();

            addCommentButton.disabled = true;
            addCommentButton.innerHTML = "<img src='img/ajax-loader.gif'>";

            var url = '/addComment';

            var formData = new FormData(newCommentBlock);
            formData.append('fileId', fileId.value);

            var response = await fetch(url, {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                updateComments();

                addCommentButton.disabled = false;
                addCommentButton.innerHTML = "Отправить";

                var windowHeight = document.documentElement.clientHeight;
                var windowWidth = document.documentElement.clientWidth;

                var commentPopup = document.createElement('div');
                commentPopup.classList.add("commentPopup");
                commentPopup.id = "commentPopup";
                commentPopup.innerHTML = "Комментарий отправлен";

                commentPopup.style.top = windowHeight - 100 + "px";
                commentPopup.style.left = windowWidth - 220 + "px";

                var body = document.getElementsByTagName('body')[0];
                body.appendChild(commentPopup);

                setTimeout(closeCommentPopup, 2000);

            } else {
                alert("error");
            }
        };

        function closeCommentPopup() {
            var body = document.getElementsByTagName('body')[0];
            body.removeChild(document.getElementById('commentPopup'));
        }

        async function updateComments(){
            var url = '/getCommentsList';

            var formData = new FormData();
            formData.append('fileId', fileId.value);

            var response = await fetch(url, {
                method: 'POST',
                body: formData
            });

            var commentsList = await response.json();

            var commentsBlock = document.createElement('div');
            commentsBlock.classList.add("commentsBlock");
            commentsBlock.id = "commentsBlock";

            for (var i = 0; i < commentsList.length; i++) {
                var comment = document.createElement('div');
                comment.classList.add("comment");

                var date = document.createElement('h5');
                date.innerHTML = commentsList[i].date;

                var p = document.createElement('p');
                p.innerHTML = commentsList[i].text;

                var a = document.createElement("a");
                a.href = '';
                a.innerHTML = "Ответить";

                comment.appendChild(date);
                comment.appendChild(p);
                comment.appendChild(a);
                commentsBlock.appendChild(comment);
            }

            newCommentsText.value = "";

            var body = document.getElementsByTagName('body')[0];
            body.removeChild(document.getElementById('commentsBlock'));
            body.insertBefore(commentsBlock, document.getElementById('newCommentBlock'));
        }
    </script>
</body>
</html>